# 登录功能增强

## 概述

本次更新增强了登录功能，支持用户名或手机号登录，并将手机号字段改为可选。

## 主要修改

### 1. 用户模型修改 (src/models/user.js)

- **手机号字段改为可选**：
  - 移除了 `required: true` 约束
  - 添加了 `sparse: true` 选项，允许空值但保持唯一性
  - 更新了验证器，允许空值通过验证

```javascript
phone: {
  type: String,
  unique: true,
  sparse: true, // 允许空值，但如果有值则必须唯一
  validate: {
    validator: function(v) {
      // 如果手机号为空，则验证通过
      if (!v) return true
      // 如果手机号不为空，则验证格式
      return /^1\d{10}$/.test(v)
    },
    message: '手机号格式不正确'
  }
}
```

### 2. 登录逻辑增强

#### 支持用户名或手机号登录

在两个登录路由文件中都实现了以下逻辑：

```javascript
// 查找用户 - 支持用户名或手机号登录
let user = await User.findOne({ username }).select('+password')

// 如果用户名没找到，尝试用手机号查找
if (!user && /^1\d{10}$/.test(username)) {
  user = await User.findOne({ phone: username }).select('+password')
}
```

#### 错误消息更新

- 将错误消息从"用户名或密码错误"更新为"用户名/手机号或密码错误"
- 提示信息更加准确，告知用户可以使用用户名或手机号登录

### 3. 用户管理功能更新

#### 创建用户
- 手机号字段变为可选
- 只有在提供手机号时才进行重复性检查

#### 更新用户
- 手机号字段变为可选
- 只有在提供手机号时才进行重复性检查

#### 注册功能
- 手机号字段变为可选
- 邮箱字段变为必填
- 只有在提供手机号时才进行格式和重复性检查

## 登录流程

1. **输入验证**：用户输入用户名/手机号和密码
2. **用户查找**：
   - 首先尝试用输入值作为用户名查找
   - 如果没找到且输入值符合手机号格式，则尝试用手机号查找
3. **状态验证**：检查用户状态是否为激活状态
4. **密码验证**：验证密码是否正确
5. **登录成功**：更新最后登录时间，生成JWT token，记录登录日志

## 使用示例

### 用户名登录
```json
{
  "username": "admin",
  "password": "admin123"
}
```

### 手机号登录
```json
{
  "username": "13800138000",
  "password": "admin123"
}
```

## 注意事项

1. **手机号格式**：手机号必须符合中国大陆手机号格式（11位，以1开头）
2. **唯一性**：如果设置了手机号，则必须唯一
3. **可选性**：手机号字段完全可选，不会影响用户创建和登录
4. **向后兼容**：现有用户数据不受影响

## 影响范围

- ✅ 用户注册
- ✅ 用户登录
- ✅ 用户创建
- ✅ 用户更新
- ✅ 数据库模型
- ✅ 错误处理

## 测试建议

1. 使用用户名登录
2. 使用手机号登录
3. 创建不带手机号的用户
4. 创建带手机号的用户
5. 更新用户手机号
6. 验证手机号格式检查
7. 验证手机号唯一性检查 